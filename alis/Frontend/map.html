<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALIS Risk Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: white;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid #334155;
            max-width: 300px;
        }

        .info-panel h3 {
            margin-bottom: 10px;
            color: #60a5fa;
        }

        .legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #334155;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            font-size: 13px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .stats-bar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            padding: 10px 30px;
            border-radius: 10px;
            border: 1px solid #334155;
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 11px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-size: 20px;
        }

        .loading.hidden {
            display: none;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            background: #1e293b;
            color: white;
            border-radius: 8px;
        }

        .custom-popup .leaflet-popup-tip {
            background: #1e293b;
        }

        .popup-content {
            min-width: 200px;
        }

        .popup-content h4 {
            color: #60a5fa;
            margin-bottom: 8px;
            border-bottom: 1px solid #334155;
            padding-bottom: 5px;
        }

        .popup-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 13px;
        }

        .popup-label {
            color: #94a3b8;
        }

        .risk-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .risk-critical {
            background: #ef4444;
        }

        .risk-high {
            background: #f97316;
        }

        .risk-medium {
            background: #eab308;
            color: #000;
        }

        .risk-low {
            background: #22c55e;
        }

        /* Filter panel */
        .filter-panel {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #334155;
            width: 250px;
        }

        .filter-panel label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #94a3b8;
        }

        .filter-panel select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #334155;
            background: #1e293b;
            color: white;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="loading" class="loading">
        <div>üîÑ Loading risk data from API...</div>
    </div>

    <div class="stats-bar" id="stats-bar">
        <div class="stat-item">
            <div class="stat-value" id="total-pincodes">-</div>
            <div class="stat-label">Pincodes</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" style="color: #ef4444;" id="critical-count">-</div>
            <div class="stat-label">Critical</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" style="color: #f97316;" id="high-count">-</div>
            <div class="stat-label">High Risk</div>
        </div>
        <div class="stat-value" style="color: #22c55e;" id="low-count">-</div>
        <div class="stat-label">Low Risk</div>
    </div>
    </div>

    <div class="filter-panel">
        <label>Filter by State</label>
        <select id="state-filter">
            <option value="all">All States</option>
        </select>

        <label>Filter by Risk Level</label>
        <select id="risk-filter">
            <option value="all">All Risk Levels</option>
            <option value="CRITICAL">üî¥ Critical</option>
            <option value="HIGH">üü† High</option>
            <option value="MEDIUM">üü° Medium</option>
            <option value="LOW">üü¢ Low</option>
        </select>
    </div>

    <div class="legend">
        <strong style="display: block; margin-bottom: 10px;">Risk Levels</strong>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div>
            <span>Critical (80-100)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f97316;"></div>
            <span>High (60-79)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #eab308;"></div>
            <span>Medium (40-59)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #22c55e;"></div>
            <span>Low (0-39)</span>
        </div>
    </div>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // API endpoint
        const API_BASE = 'http://localhost:8000/api/v1';

        // Pincode to coordinates (approximate based on prefix)
        const PINCODE_COORDS = {
            '11': { lat: 28.7041, lng: 77.1025, state: 'Delhi' },
            '12': { lat: 29.0588, lng: 76.0856, state: 'Haryana' },
            '13': { lat: 31.1471, lng: 75.3412, state: 'Punjab' },
            '14': { lat: 31.3260, lng: 75.5762, state: 'Punjab' },
            '20': { lat: 26.8467, lng: 80.9462, state: 'Uttar Pradesh' },
            '21': { lat: 26.4499, lng: 80.3319, state: 'Uttar Pradesh' },
            '22': { lat: 25.4358, lng: 81.8463, state: 'Uttar Pradesh' },
            '23': { lat: 27.1767, lng: 78.0081, state: 'Uttar Pradesh' },
            '24': { lat: 28.4089, lng: 77.3178, state: 'Uttar Pradesh' },
            '25': { lat: 29.3919, lng: 79.4542, state: 'Uttarakhand' },
            '26': { lat: 28.6692, lng: 77.4538, state: 'Uttar Pradesh' },
            '27': { lat: 26.7606, lng: 83.3732, state: 'Uttar Pradesh' },
            '28': { lat: 27.8974, lng: 78.0880, state: 'Uttar Pradesh' },
            '30': { lat: 26.9124, lng: 75.7873, state: 'Rajasthan' },
            '31': { lat: 28.0229, lng: 73.3119, state: 'Rajasthan' },
            '32': { lat: 27.0238, lng: 74.2179, state: 'Rajasthan' },
            '33': { lat: 26.2389, lng: 73.0243, state: 'Rajasthan' },
            '34': { lat: 24.8829, lng: 74.6230, state: 'Rajasthan' },
            '36': { lat: 23.0225, lng: 72.5714, state: 'Gujarat' },
            '37': { lat: 22.3072, lng: 73.1812, state: 'Gujarat' },
            '38': { lat: 21.1702, lng: 72.8311, state: 'Gujarat' },
            '39': { lat: 22.4707, lng: 70.0577, state: 'Gujarat' },
            '40': { lat: 19.0760, lng: 72.8777, state: 'Maharashtra' },
            '41': { lat: 19.9975, lng: 73.7898, state: 'Maharashtra' },
            '42': { lat: 18.5204, lng: 73.8567, state: 'Maharashtra' },
            '43': { lat: 19.8762, lng: 75.3433, state: 'Maharashtra' },
            '44': { lat: 21.1458, lng: 79.0882, state: 'Maharashtra' },
            '45': { lat: 23.2599, lng: 77.4126, state: 'Madhya Pradesh' },
            '46': { lat: 22.7196, lng: 75.8577, state: 'Madhya Pradesh' },
            '47': { lat: 26.2183, lng: 78.1828, state: 'Madhya Pradesh' },
            '48': { lat: 23.1815, lng: 79.9864, state: 'Madhya Pradesh' },
            '49': { lat: 21.2514, lng: 81.6296, state: 'Chhattisgarh' },
            '50': { lat: 17.3850, lng: 78.4867, state: 'Telangana' },
            '51': { lat: 18.1124, lng: 79.0193, state: 'Telangana' },
            '52': { lat: 16.5062, lng: 80.6480, state: 'Andhra Pradesh' },
            '53': { lat: 17.6868, lng: 83.2185, state: 'Andhra Pradesh' },
            '56': { lat: 12.9716, lng: 77.5946, state: 'Karnataka' },
            '57': { lat: 12.2958, lng: 76.6394, state: 'Karnataka' },
            '58': { lat: 15.3647, lng: 75.1240, state: 'Karnataka' },
            '59': { lat: 15.8497, lng: 74.4977, state: 'Karnataka' },
            '60': { lat: 13.0827, lng: 80.2707, state: 'Tamil Nadu' },
            '61': { lat: 11.0168, lng: 76.9558, state: 'Tamil Nadu' },
            '62': { lat: 10.7905, lng: 78.7047, state: 'Tamil Nadu' },
            '63': { lat: 9.9252, lng: 78.1198, state: 'Tamil Nadu' },
            '64': { lat: 8.0883, lng: 77.5385, state: 'Tamil Nadu' },
            '67': { lat: 11.2588, lng: 75.7804, state: 'Kerala' },
            '68': { lat: 9.9312, lng: 76.2673, state: 'Kerala' },
            '69': { lat: 8.5241, lng: 76.9366, state: 'Kerala' },
            '70': { lat: 22.5726, lng: 88.3639, state: 'West Bengal' },
            '71': { lat: 22.9868, lng: 87.8550, state: 'West Bengal' },
            '72': { lat: 23.2324, lng: 87.8615, state: 'West Bengal' },
            '73': { lat: 22.4155, lng: 87.3119, state: 'West Bengal' },
            '74': { lat: 26.7271, lng: 88.3953, state: 'West Bengal' },
            '75': { lat: 20.2961, lng: 85.8245, state: 'Odisha' },
            '76': { lat: 19.8135, lng: 85.8312, state: 'Odisha' },
            '77': { lat: 21.4669, lng: 83.9812, state: 'Odisha' },
            '78': { lat: 26.1445, lng: 91.7362, state: 'Assam' },
            '80': { lat: 25.6093, lng: 85.1376, state: 'Bihar' },
            '81': { lat: 25.5941, lng: 85.1376, state: 'Bihar' },
            '82': { lat: 25.3176, lng: 86.9905, state: 'Bihar' },
            '83': { lat: 26.1197, lng: 85.3910, state: 'Bihar' },
            '84': { lat: 26.6528, lng: 85.1644, state: 'Bihar' },
            '85': { lat: 23.3441, lng: 85.3096, state: 'Jharkhand' },
            '86': { lat: 24.7914, lng: 85.9996, state: 'Jharkhand' },
        };

        // Get coordinates for a pincode
        function getPincodeCoords(pincode) {
            const prefix = pincode.substring(0, 2);
            const base = PINCODE_COORDS[prefix];

            if (base) {
                // Add slight randomization for visual spread
                const latOffset = (Math.random() - 0.5) * 1.5;
                const lngOffset = (Math.random() - 0.5) * 1.5;
                return {
                    lat: base.lat + latOffset,
                    lng: base.lng + lngOffset,
                    state: base.state
                };
            }
            return null;
        }

        // Get color based on risk
        function getRiskColor(score) {
            if (score >= 80) return '#ef4444';
            if (score >= 60) return '#f97316';
            if (score >= 40) return '#eab308';
            return '#22c55e';
        }

        // Initialize map
        const map = L.map('map', {
            center: [22.5, 82.5],
            zoom: 5,
            zoomControl: true,
            scrollWheelZoom: true
        });

        // Dark tile layer
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap, &copy; CARTO',
            maxZoom: 18
        }).addTo(map);

        // Marker cluster group
        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
            iconCreateFunction: function (cluster) {
                const count = cluster.getChildCount();
                let size = 'small';
                if (count > 100) size = 'large';
                else if (count > 50) size = 'medium';

                return L.divIcon({
                    html: `<div><span>${count}</span></div>`,
                    className: `marker-cluster marker-cluster-${size}`,
                    iconSize: L.point(40, 40)
                });
            }
        });

        let allData = [];
        let statesSet = new Set();

        // Fetch data from API
        async function loadData() {
            try {
                // Try API first - use map-data endpoint which is optimized and has no limit
                const response = await fetch(`${API_BASE}/pincodes/map-data`);

                if (response.ok) {
                    const data = await response.json();
                    allData = data.items || data;
                    processData(allData);
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.log('API error, using sample data:', error);
                // Generate sample data if API fails
                generateSampleData();
            }

            document.getElementById('loading').classList.add('hidden');
        }

        // Generate sample data for demo
        function generateSampleData() {
            const sampleData = [];
            const categories = ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW'];

            for (let i = 0; i < 500; i++) {
                const prefixes = Object.keys(PINCODE_COORDS);
                const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
                const pincode = prefix + String(Math.floor(Math.random() * 10000)).padStart(4, '0');
                const riskScore = Math.random() * 100;

                sampleData.push({
                    pincode: pincode,
                    overall_risk_score: riskScore,
                    risk_category: riskScore >= 80 ? 'CRITICAL' : riskScore >= 60 ? 'HIGH' : riskScore >= 40 ? 'MEDIUM' : 'LOW',
                    total_bio_updates: Math.floor(Math.random() * 10000),
                    total_demo_updates: Math.floor(Math.random() * 5000),
                    state: PINCODE_COORDS[prefix]?.state || 'Unknown'
                });
            }

            allData = sampleData;
            processData(allData);
        }

        // Process and display data
        function processData(data) {
            markers.clearLayers();

            let criticalCount = 0, highCount = 0, lowCount = 0;

            const stateFilter = document.getElementById('state-filter').value;
            const riskFilter = document.getElementById('risk-filter').value;

            data.forEach(item => {
                const coords = getPincodeCoords(item.pincode);
                if (!coords) return;

                const state = item.state || coords.state;
                statesSet.add(state);

                // Apply filters
                if (stateFilter !== 'all' && state !== stateFilter) return;
                if (riskFilter !== 'all' && item.risk_category !== riskFilter) return;

                const riskScore = item.overall_risk_score || 0;
                const category = item.risk_category || 'LOW';

                // Count
                if (category === 'CRITICAL') criticalCount++;
                else if (category === 'HIGH') highCount++;
                else if (category === 'LOW') lowCount++;

                // Create marker
                const marker = L.circleMarker([coords.lat, coords.lng], {
                    radius: 8,
                    fillColor: getRiskColor(riskScore),
                    color: '#fff',
                    weight: 1,
                    opacity: 0.9,
                    fillOpacity: 0.8
                });

                // Popup content
                const popupContent = `
                    <div class="popup-content">
                        <h4>üìç ${item.pincode}</h4>
                        <div class="popup-row">
                            <span class="popup-label">State</span>
                            <span>${state}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">Risk Score</span>
                            <span>${riskScore.toFixed(1)}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">Category</span>
                            <span class="risk-badge risk-${category.toLowerCase()}">${category}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">Bio Updates</span>
                            <span>${(item.total_bio_updates || 0).toLocaleString()}</span>
                        </div>
                        <div class="popup-row">
                            <span class="popup-label">Demo Updates</span>
                            <span>${(item.total_demo_updates || 0).toLocaleString()}</span>
                        </div>
                    </div>
                `;

                marker.bindPopup(popupContent, { className: 'custom-popup' });
                markers.addLayer(marker);
            });

            map.addLayer(markers);

            // Update stats
            document.getElementById('total-pincodes').textContent = data.length.toLocaleString();
            document.getElementById('critical-count').textContent = criticalCount.toLocaleString();
            document.getElementById('high-count').textContent = highCount.toLocaleString();
            document.getElementById('low-count').textContent = lowCount.toLocaleString();

            // Update state filter
            updateStateFilter();
        }

        // Update state filter dropdown
        function updateStateFilter() {
            const select = document.getElementById('state-filter');
            const currentValue = select.value;

            // Clear and rebuild
            select.innerHTML = '<option value="all">All States</option>';

            Array.from(statesSet).sort().forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                if (state === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }

        // Filter change handlers
        document.getElementById('state-filter').addEventListener('change', () => processData(allData));
        document.getElementById('risk-filter').addEventListener('change', () => processData(allData));

        // Load data on page load
        loadData();

        // Add custom cluster styles
        const style = document.createElement('style');
        style.textContent = `
            .marker-cluster {
                background-clip: padding-box;
                border-radius: 20px;
            }
            .marker-cluster div {
                width: 30px;
                height: 30px;
                margin-left: 5px;
                margin-top: 5px;
                text-align: center;
                border-radius: 15px;
                font-size: 12px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .marker-cluster-small {
                background-color: rgba(34, 197, 94, 0.6);
            }
            .marker-cluster-small div {
                background-color: rgba(34, 197, 94, 0.9);
                color: white;
            }
            .marker-cluster-medium {
                background-color: rgba(234, 179, 8, 0.6);
            }
            .marker-cluster-medium div {
                background-color: rgba(234, 179, 8, 0.9);
                color: black;
            }
            .marker-cluster-large {
                background-color: rgba(239, 68, 68, 0.6);
            }
            .marker-cluster-large div {
                background-color: rgba(239, 68, 68, 0.9);
                color: white;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>